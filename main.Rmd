---
title: "Real Data Analysis"
author: "Xu Guo, Runze Li, Jingyuan Liu, Mudong Zeng"
output: 
  html_document:
    number_sections: true
---

This Rmd is devoted to an empirical analysis of the same data set as that in Houtepen et al. (2016) and van Kesteren & Oberski (2019), for studying how DNA methylation plays a role in the regulation of human stress reactivity. This Rmd aims to reproduce the results in Section 3.

The data can be downloaded from the following website:
https://www.ebi.ac.uk/arrayexpress/experiments/E-GEOD-77445, and the data set consists of 385,882 DNA methylation loci and various variables for 85 people.

```{r setup, include=FALSE}
# Load source codes
source("utils.R")
```

# Preprocess raw data
The original data available to the authors are .txt files. We loaded these files and merged into a clean data set (containing two vectors, exposure variable X as well as response variable y, and two dataframes potential mediators M as well as confounding variables S). To make it convenient for further analysis, we stored it in a .RData file. 

## Load data frame from participant info
```{r RawData, eval=FALSE, warning=FALSE, include=FALSE}
# The path of the folder that contains txt files
PATH = "C:/Users/49849/Documents/R/research/ema_simulations/data_application/data/"
RawDataPath = LoadRawData(InputPath = PATH)
```

## Marginal screening for potential mediators
We  carry out a screening step to
retain the top 1000 potential mediators by ranking the absolute value of the
product of two correlations - the correlation between $\mathbf{x}$ and each element of $\m$, and between $y$ and each element of $\m$. This indeed is a marginal screening procedure based on Pearson correlation proposed by Fan & Lv (2008).

```{r Preprocess, echo=TRUE, message=TRUE, warning=FALSE, paged.print=FALSE}
RawDataPath = "results/raw_data.Rdata"
topPotential = 1000
cleanedData = MarginalScreening(RawDataPath, topPotential = topPotential)
load(cleanedData)
```

# Our proposed new method
Procedure of identifying active mediators in the mediation
models (2.1) and (2.2), and estimating the direct effect $\mathbf{\alpha_1}$ and indirect effect $\boldsymbol{\beta}$ that can get around high dimensional matrix estimation.

## Identifying active mediators
we apply the partial penalized least squared method to fit model (2.1) by only penalizing $\boldsymbol{\alpha}_0$, which corresponding to Eq. (2.5). 

### Algorithm for solving Eq. (2.5)
We apply the local linear approximation algorithm
(LLA) in Zou and Li (2008) with the SCAD penalty (Fan & Li, 2001)
,
$$
p'_{\lambda}(t)=\lambda\{I(t\leq \lambda)
+\frac{(a\lambda-t)_{+}}{(a-1)\lambda}I(t>\lambda)\},
$$
and set $a=3.7$. The tuning parameter $\lambda$ for our method is chosen based on the high-dimensional
BIC (HBIC) method in Wang et al. (2013).
For a fixed regularization parameter $\lambda$, define
$$(\hat{\boldsymbol{\alpha}}_0^{\lambda}, \hat{\boldsymbol{\alpha}}_1^{\lambda})=\min_{\boldsymbol{\alpha}_0,\boldsymbol{\alpha}_1}\frac{1}{2n}\|\mathbf{Y}-\mathbf{M}\boldsymbol{\alpha}_{0}-\mathbf{X}\boldsymbol{\alpha}_1\|^2_2+\sum_{j=1}^p p_{\lambda}(|\alpha_{0,j}|).$$
The minimization of the  partially penalized least squares method can
be carried out as follows.

1. Get initial values for $\boldsymbol{\alpha}^{(0)}_0,\boldsymbol{\alpha}^{(0)}_1$ by minimizing a
partial $L_1$-penalized least squares:
$$(\hat{\boldsymbol{\alpha}}_0^{(0)}, \hat{\boldsymbol{\alpha}}_1^{(0)})=\min_{\boldsymbol{\alpha}_0,\boldsymbol{\alpha}_1}
\frac{1}{2n}\|\mathbf{Y}-\mathbf{M}\boldsymbol{\alpha}_{0}-\mathbf{X}\boldsymbol{\alpha}_1\|^2_2+\lambda\sum_{j=1}^p |\alpha_{0,j}|.$$

2. Solve
$$(\hat{\boldsymbol{\alpha}}_0^{(k+1)}, \hat{\boldsymbol{\alpha}}_1^{(k+1)})=\min_{\boldsymbol{\alpha}_0,\boldsymbol{\alpha}_1}
\frac{1}{2n}\|\mathbf{Y}-\mathbf{M}\boldsymbol{\alpha}_{0}-\mathbf{X}\boldsymbol{\alpha}_1\|^2_2+\sum_{j=1}^p p'_{\lambda}(|\alpha^{(k)}_{0,j}|)|\alpha_{0,j}|, \text{ for } k=1,2,\cdots,$$
until $\{(\hat{\boldsymbol{\alpha}}_0^{(k)}, \hat{\boldsymbol{\alpha}}_1^{(k)})\}$ converges.

Below is the implementation of solving Eq. (2.5).
The candidate set of $\lambda$ is 50 equally spaced grid from 20 to 70.
```{r LLA, echo=TRUE, warning=FALSE, paged.print=TRUE}
load("results/preproc_JASA.Rdata")
topPotential = 1000

deSCAD <- function(z,lamb,a=3.7){
  # First order derivative of SCAD penalty
  # tuning parameter "a" (or "gamma") use the default value 3.7
  return(1*(z<=lamb)+pmax((a*lamb-z),0)/((a-1)*lamb)*(lamb<z))
}

## ONE-STEP SPARSE ESTIMATES IN NONCONCAVE PENALIZED LIKELIHOOD MODELS
LLA_h1<- function(X,Y,M,lamb,n,p,q, n_imp = 0,S = NULL){
  if(length(S) == 0){
    s = 0
    V = X
  }else{
    s = ncol(S)
    V = cbind(X,S)
  }
  # Step 1 using Lasso
  w1 = matrix(0,nrow = (p + q + s),ncol=1)
  w1[1:(p-n_imp)] = 1
  alpha_int = coef(glmnet(cbind(M,V),Y,family = 'gaussian', alpha=1,
                          lambda = lamb, penalty.factor=w1,intercept = FALSE))[-1]
  # Step 2 using linear approximation of SCAD
  w2 = matrix(0,nrow = (p+q + s),ncol=1)
  for(j in 1:(p- n_imp)){
    w2[j] = deSCAD(alpha_int[j],lamb)
  }
  alpha = coef(glmnet(cbind(M,V),Y,family = 'gaussian', alpha=1,
                      lambda = lamb, penalty.factor=w2, intercept = FALSE))
  return(alpha[-1])
}
HBIC_calc <- function(lamb, xx,yy,mm,S = NULL, n_imp =8){
  # S is cofounder
  n = nrow(xx)
  p = ncol(mm)
  q = ncol(xx)
  if(is.null(S)){
    s = 0
    result <- LLA_h1(xx,yy,mm,lamb,n,p,q, n_imp = n_imp)
    alpha0 = result[1:p]
    alpha1 = result[(p+1):(p+q)]
    alpha2 = NULL
    tmp = yy - mm%*%alpha0 - xx%*% alpha1
  }else{
    s = ncol(S)
    result <- LLA_h1(xx,yy,mm,lamb,n,p,q,n_imp = n_imp, S = S)
    alpha0 = result[1:p]
    alpha1 = result[(p+1):(p+q)]
    alpha2 = result[(p+q+1):(p+q+s)]
    
    tmp = yy - mm%*%alpha0 - xx%*% alpha1 - S %*% alpha2
  }
  
  df = length(which(alpha0!= 0))+q + s
  sigma_hat = t(tmp)%*%tmp/n
  BIC = log(sigma_hat) + df*log(log(n))*log(p+q + s)/n
  #obj = objective(xx,yy,M,alpha0,alpha1,lamb)
  return(list(BIC=BIC,alpha0=alpha0,alpha1 = alpha1, 
              alpha2 = alpha2, sigma1_hat = sigma_hat))
}


HBIC_PPLS <- function(X, y, M, S = NULL, lam_list =NULL, n_imp =8){
    #' This function implements solving the partially penalized least squares with the SCAD penalty. The tuning parameter lambda for the penalty function is chosen based on the high-dimensional BIC (HBIC) method.
  #' @param X The n by q exposure matrix. q can be 1, and q < n is required
  #' @param y The n-dimensional outcome vector.
  #' @param M The n by p mediator matrix. p can be larger than n.
  #' @param S The n by s confounding variables matrix. s can be 1, and s < n is required.
  #' 
  #' @param lam_list a list of tuning parameter for HBIC
  
  #' @return
  #'
  #'    A dataframe of selected important mediators (denoted as M_{\hat{A}} in the paper)
  hbic= c()
  
  result =lapply(lam_list, HBIC_calc, xx=X,yy=y, mm=M, S = S, n_imp = n_imp)
  
  for( ii in 1: length(lam_list)){
    hbic[ii] = result[[ii]]$BIC
  }
  # Find minimum HBIC score's corresponding lambda
  id = which(hbic==min(hbic))
  id = tail(id,1)
  lamb = lam_list[id]
  print(paste("choose lambda:", lamb))
  result = result[[id]]
  alpha0_hat = result$alpha0
  alpha1_hat = result$alpha1
  
  A = which(alpha0_hat!=0)
  # Selected mediators 
  M_A = M[,c(A[A>topPotential],A[A<=topPotential])]
  
}

# specify the candidate set of lambda
lamb_min = 20
lamb_max = 70
ngrid = 50
lam_list = seq(lamb_min,lamb_max,length.out = ngrid)

M_A = HBIC_PPLS(X, y, M, S = S, lam_list =lam_list, n_imp =8)
```

### Estimated Coefficients, SE, t-values and p-values (Table 2)
```{r Table2, warning=FALSE}
# Refit to produce Table 2:
colnames(S) = paste0("Z",0:8)
df = data.frame(cbind(M_A, X, S))
round(summary(lm(y~ 0+., data = df))$coefficients,digits = 3)
```


### Estimated Coefficients of $\Gamma_1$ and $\Gamma_2$ and their p-values (Table 3)
```{r}
colnames(M_A) = paste0("m",1:11)
Gamma = MediatorExposure(cbind(X, S), M_A)
round(Gamma$Gamma_hat,digits = 3)
round(Gamma$Gamma_pvalue,digits = 3)
```


## Test of direct effect and indirect effect (Table 4)
```{r}
HDMediationInference(X, y, M_A, S)
```
